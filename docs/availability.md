# BUD - 可用性設計ガイド

BUD アプリケーションの可用性要件、障害対応、サービス継続性を定義します。

## 🎯 可用性目標・SLA

### サービス目標

| 指標               | 目標値         | 重要度 | 理由                                   |
| ------------------ | -------------- | ------ | -------------------------------------- |
| **稼働率**         | 99.5%          | 最高   | 親子のコミュニケーション機会を逃さない |
| **レスポンス時間** | 95%が 2 秒以内 | 高     | 子どもの集中力維持                     |
| **音声処理**       | 99.0%          | 高     | 音声機能は BUD の核心機能              |
| **データ復旧時間** | < 4 時間       | 高     | 長期間のサービス停止を避ける           |
| **データ損失**     | < 1 時間分     | 最高   | 子どもの記録を保護                     |

### 許容ダウンタイム

- **月間**: 3.6 時間以内
- **計画メンテナンス**: 月 2 時間以内（深夜帯）
- **緊急メンテナンス**: 年 12 時間以内

---

## 🏗️ システム構成設計

### 基本アーキテクチャ

```
[ユーザー]
    ↓
[CDN/ロードバランサー]
    ↓
[フロントエンド] × 2台（冗長化）
    ↓
[バックエンドAPI] × 2台（冗長化）
    ↓
[データベース] Primary + Read Replica
    ↓
[バックアップストレージ]
```

### 冗長化方針

#### 1. アプリケーションレベル

- **フロントエンド**: 複数インスタンス + ロードバランサー
- **バックエンド**: 複数インスタンス + ヘルスチェック
- **外部 API**: フォールバック機能（Whisper API ⇄ Web Speech API）

#### 2. データベースレベル

- **Primary-Replica 構成**: 読み書き分離
- **自動フェイルオーバー**: Primary 障害時の Replica 昇格
- **バックアップ**: 日次自動バックアップ + 長期保管

#### 3. インフラレベル

- **マルチ AZ**: 複数の可用性ゾーンに分散
- **Auto Scaling**: 負荷に応じた自動スケーリング
- **CDN**: 静的コンテンツの配信最適化

---

## 🔄 障害検知・復旧

### ヘルスチェック項目

| 対象                 | チェック内容             | 間隔  | 閾値         |
| -------------------- | ------------------------ | ----- | ------------ |
| **アプリケーション** | `/health` エンドポイント | 30 秒 | 3 回連続失敗 |
| **データベース**     | 接続確認 + 簡単なクエリ  | 60 秒 | 2 回連続失敗 |
| **外部 API**         | OpenAI API 接続確認      | 5 分  | 1 回失敗     |
| **ストレージ**       | 読み書きテスト           | 5 分  | 1 回失敗     |

### 自動復旧アクション

```
障害検知
    ↓
1. サービス再起動
    ↓（失敗時）
2. 別インスタンスへ切り替え
    ↓（失敗時）
3. 人的対応にエスカレーション
```

### アラート通知

- **Critical**: 即座に Slack + メール通知
- **Warning**: Slack 通知のみ
- **Info**: ダッシュボード記録のみ

---

## 💾 バックアップ・災害復旧

### バックアップ戦略

| 種類             | 頻度   | 保存期間 | 復旧時間 |
| ---------------- | ------ | -------- | -------- |
| **データベース** | 日次   | 30 日    | 2 時間   |
| **ファイル**     | 週次   | 12 週    | 4 時間   |
| **設定ファイル** | 変更時 | 無期限   | 30 分    |

### 災害復旧シナリオ

#### シナリオ 1: データベース障害

1. **検知**: 2 分以内
2. **初期対応**: Read Replica への読み取り切り替え（5 分）
3. **復旧**: Primary 修復または Replica の Primary 昇格（30 分）
4. **完全復旧**: 新しい Replica 構築（2 時間）

#### シナリオ 2: アプリケーション障害

1. **検知**: 1 分以内
2. **初期対応**: 正常インスタンスへのトラフィック切り替え（2 分）
3. **復旧**: 障害インスタンスの再起動または交換（10 分）

#### シナリオ 3: 外部 API 障害（OpenAI）

1. **検知**: 5 分以内
2. **初期対応**: Web Speech API へのフォールバック（即座）
3. **復旧**: OpenAI API 復旧後の自動切り戻し

---

## 📊 監視・分析

### 監視ダッシュボード項目

- **稼働率**: リアルタイム稼働状況
- **レスポンス時間**: 95 パーセンタイル値
- **エラー率**: 時間別エラー発生率
- **外部 API 状況**: OpenAI 等の依存サービス状況

### 定期レビュー

- **週次**: 可用性指標の確認
- **月次**: SLA 達成状況の評価
- **四半期**: 災害復旧テストの実施

---

## 🚨 障害対応手順

### 緊急時連絡体制

```
障害検知（自動）
    ↓
開発チーム（5分以内）
    ↓（重大障害時）
プロジェクトマネージャー（15分以内）
    ↓（ユーザー影響大）
ステークホルダー（30分以内）
```

### 対応レベル

| レベル | 定義           | 対応時間     | 担当者             |
| ------ | -------------- | ------------ | ------------------ |
| **P1** | サービス全停止 | 5 分以内     | 開発チーム全員     |
| **P2** | 主要機能停止   | 30 分以内    | 開発チームリーダー |
| **P3** | 一部機能障害   | 2 時間以内   | 担当開発者         |
| **P4** | 軽微な問題     | 1 営業日以内 | 担当開発者         |

---

## ⚡ 実装優先度

### Phase 1: 基本的な可用性（MVP）

- [ ] 基本的なヘルスチェック実装
- [ ] データベースバックアップ自動化
- [ ] 基本的な監視ダッシュボード

### Phase 2: 冗長化強化

- [ ] アプリケーションの複数インスタンス化
- [ ] データベース Read Replica 構築
- [ ] Auto Scaling 設定

### Phase 3: 高度な可用性

- [ ] 自動フェイルオーバー実装
- [ ] 災害復旧テスト実施
- [ ] 詳細な性能監視

---

## 📋 運用チェックリスト

### 日次チェック

- [ ] 稼働率・エラー率の確認
- [ ] バックアップ完了確認
- [ ] 外部 API 状況確認

### 週次チェック

- [ ] 可用性指標のレビュー
- [ ] ログ分析・異常検知
- [ ] セキュリティアップデート確認

### 月次チェック

- [ ] SLA 達成状況の評価
- [ ] 災害復旧計画の見直し
- [ ] インフラコストの最適化

---

## 💡 コスト最適化

### 効率的な可用性実現

- **必要最小限の冗長化**: 過度なスケールを避ける
- **クラウドサービス活用**: 管理コストの削減
- **スポットインスタンス**: 開発・テスト環境での活用
- **自動スケーリング**: 需要に応じたリソース調整

### 監視コスト管理

- **重要指標に集中**: 本当に必要な監視項目のみ
- **アラート最適化**: false positive の削減
- **ログ保存期間**: 適切な期間設定でストレージコスト削減

---

## 📝 まとめ

BUD の可用性設計は**実用性とコストのバランス**を重視し、段階的に成熟度を高めていく方針です。

**重要原則**:

1. **ユーザー影響を最小化**: 親子のコミュニケーション機会を守る
2. **実装の現実性**: チームリソースに見合った可用性レベル
3. **継続的改善**: 運用しながら可用性を向上
4. **コスト効率**: 過度な冗長化を避け、必要十分な可用性を実現

小規模チームでも実現可能な、実用的な可用性を目指します。
