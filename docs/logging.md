# BUD - ログ設計ガイド

BUD アプリケーションのログ管理方針、ログレベル、監査要件、運用方法を定義します。

## 🎯 ログ設計の目的・方針

### 基本方針

- **透明性**: システムの動作状況を可視化
- **追跡可能性**: 問題の原因を迅速に特定
- **監査対応**: セキュリティ・コンプライアンス要件を満たす
- **プライバシー保護**: 個人情報・音声データの適切な保護
- **運用効率**: 実際に活用できるログ設計

### ログ分類・保存期間

| ログ種別                 | 目的                 | 保存期間 | 重要度 |
| ------------------------ | -------------------- | -------- | ------ |
| **アプリケーションログ** | 業務処理の記録       | 6 か月   | 高     |
| **エラーログ**           | システム障害・例外   | 1 年     | 高     |
| **監査ログ**             | セキュリティ関連操作 | 2 年     | 最高   |
| **アクセスログ**         | API 呼び出し履歴     | 3 か月   | 中     |
| **音声処理ログ**         | 音声機能利用履歴     | 3 か月   | 高     |

---

## 📊 ログレベル定義

### 標準ログレベル

| レベル    | 用途                       | 出力環境           | 例                                     |
| --------- | -------------------------- | ------------------ | -------------------------------------- |
| **ERROR** | システム障害・重大なエラー | 全環境             | データベース接続失敗、API 呼び出し失敗 |
| **WARN**  | 警告・潜在的な問題         | 全環境             | リトライ処理、レスポンス遅延、認証失敗 |
| **INFO**  | 重要な業務処理             | 全環境             | ユーザー登録、会話作成、音声変換完了   |
| **DEBUG** | 開発・デバッグ用詳細情報   | 開発・ステージング | 関数の引数・戻り値、詳細な処理フロー   |

### 環境別ログレベル設定

```bash
# 本番環境
LOG_LEVEL=INFO

# ステージング環境
LOG_LEVEL=DEBUG

# 開発環境
LOG_LEVEL=DEBUG
```

---

## 🖥️ ログ出力方針

### フロントエンド（Next.js）

#### 基本実装方針

- **構造化ログ**: JSON 形式での統一出力
- **セッション追跡**: リクエスト ID による追跡
- **エラー処理**: 自動的なエラーログ出力
- **プライバシー**: 個人情報の除外

#### 主要ログ出力箇所

```typescript
// 主要な出力ポイント
- 認証関連: ログイン成功/失敗
- API呼び出し: リクエスト/レスポンス
- 音声機能: 録音開始/終了、変換結果
- エラー処理: 予期しないエラー
- ページ遷移: 重要画面のアクセス
```

### バックエンド（FastAPI）

#### 基本実装方針

- **JSON 形式**: 統一されたログフォーマット
- **リクエスト追跡**: X-Request-ID による追跡
- **パフォーマンス**: レスポンス時間の記録
- **セキュリティ**: 認証・認可の記録

#### 主要ログ出力箇所

```python
# 主要な出力ポイント
- API endpoints: リクエスト/レスポンス
- 認証処理: トークン検証、権限チェック
- データベース: CRUD操作、エラー
- 外部API: OpenAI API呼び出し
- バックグラウンド処理: 非同期タスク
```

---

## 🔒 監査ログ設計

### セキュリティ関連操作の記録

#### 必須記録項目

| 操作                    | 記録内容                                   | 保存期間 |
| ----------------------- | ------------------------------------------ | -------- |
| **ログイン/ログアウト** | ユーザー ID、IP、タイムスタンプ、成功/失敗 | 2 年     |
| **データ変更**          | 対象データ、変更内容、実行者               | 2 年     |
| **権限変更**            | 対象ユーザー、変更内容、実行者             | 2 年     |
| **データ削除**          | 削除対象、実行者、理由                     | 2 年     |
| **管理者操作**          | 全ての管理者による操作                     | 2 年     |

#### 監査ログフォーマット

```json
{
  "timestamp": "2025-08-05T10:30:00Z",
  "event_type": "user_login",
  "user_id": "uuid",
  "ip_address": "192.168.1.100",
  "result": "success",
  "details": {
    "login_method": "google_oauth"
  }
}
```

---

## 🎤 音声機能専用ログ

### プライバシー保護ログ設計

#### 記録すべき項目

- **処理開始/完了**: タイムスタンプ、ユーザー ID
- **音声ファイル情報**: サイズ、形式（内容は記録しない）
- **変換結果**: テキスト長、信頼度スコア
- **AI 分析**: コメント生成の成功/失敗
- **データ削除**: 音声ファイル削除の確認

#### 記録してはいけない項目

- ❌ **音声ファイルの内容**
- ❌ **音声データのパス**
- ❌ **個人を特定できる音声情報**

#### 音声処理ログ例

```json
{
  "timestamp": "2025-08-05T10:30:00Z",
  "event_type": "voice_processing",
  "user_id": "uuid",
  "child_id": "uuid",
  "processing_method": "whisper_api",
  "audio_size_bytes": 1024000,
  "audio_duration_seconds": 15.5,
  "transcription_success": true,
  "transcription_length": 25,
  "confidence_score": 0.95,
  "ai_analysis_success": true,
  "audio_file_deleted": true,
  "processing_time_ms": 1500
}
```

---

## 📈 ログ分析・監視

### 重要な監視項目

#### システムヘルス

- **エラー率**: 時間当たりのエラー発生件数
- **レスポンス時間**: API 応答時間の分布
- **処理性能**: 音声変換・AI 分析の処理時間
- **リソース使用率**: CPU、メモリ、ディスク使用量

#### ビジネス指標

- **アクティブユーザー**: 日次・月次アクティブユーザー数
- **音声機能利用**: 音声メッセージ作成回数
- **エラー傾向**: 特定機能でのエラー集中
- **利用パターン**: 時間帯別の利用状況

### アラート設定

| 指標               | 閾値          | アクション     |
| ------------------ | ------------- | -------------- |
| **エラー率**       | 5%超過        | Slack 即座通知 |
| **レスポンス時間** | 平均 3 秒超過 | Slack 通知     |
| **音声処理失敗率** | 10%超過       | 緊急対応       |
| **ディスク使用率** | 90%超過       | 容量拡張検討   |

---

## 🔧 ログローテーション・保存

### ファイル管理方針

#### ローテーション設定

- **ファイルサイズ**: 100MB で分割
- **世代管理**: 最大 5 世代保持
- **圧縮**: 古いログの自動圧縮
- **削除**: 保存期間経過後の自動削除

#### ストレージ最適化

- **ホットデータ**: 直近 1 週間（高速アクセス）
- **ウォームデータ**: 1 週間-3 ヶ月（標準ストレージ）
- **コールドデータ**: 3 ヶ月以上（アーカイブストレージ）

---

## 🔍 トラブルシューティング

### よくある分析クエリ

#### エラー調査

```bash
# 特定時間のエラーログ抽出
grep "ERROR" app.log | grep "2025-08-05 14:"

# 特定ユーザーのエラー履歴
grep "user_id:abc123" app.log | grep "ERROR"

# API別エラー集計
grep "ERROR" app.log | grep "api_endpoint" | sort | uniq -c
```

#### パフォーマンス分析

```bash
# 遅いAPI呼び出しの特定
grep "process_time_ms" app.log | awk '$NF > 2000'

# 音声処理時間の分析
grep "voice_processing" app.log | awk '{print $NF}' | sort -n
```

#### セキュリティ監査

```bash
# ログイン失敗の監視
grep "login_failure" audit.log | tail -20

# 異常アクセスの検出
grep "ip_address" access.log | awk '{print $5}' | sort | uniq -c | sort -nr
```

---

## 📋 運用チェックリスト

### 日次チェック項目

- [ ] エラー率・警告数の確認
- [ ] ディスク使用量の確認
- [ ] ログローテーション状況確認
- [ ] 外部 API 呼び出し状況確認

### 週次チェック項目

- [ ] ログ保存期間の遵守確認
- [ ] パフォーマンス傾向分析
- [ ] セキュリティログの監査
- [ ] ストレージ使用量最適化

### 月次チェック項目

- [ ] ログ設定の見直し
- [ ] アラート精度の調整
- [ ] 古いログの削除実行
- [ ] ログ分析レポート作成

---

## 🔐 プライバシー・GDPR 対応

### 個人情報保護方針

#### ログでの保護対策

- **マスキング**: メールアドレス、電話番号の自動マスク
- **除外**: 音声データ、機密情報の記録禁止
- **匿名化**: 統計分析時の個人識別情報除去
- **削除**: ユーザー削除時の関連ログ除去

#### データ削除要求への対応

1. **対象特定**: ユーザー ID でログ検索
2. **範囲確認**: 削除対象ログの特定
3. **安全削除**: ログからの個人情報除去
4. **完了報告**: 削除完了証明書の発行

---

## 💡 実装優先度

### Phase 1: 基本ログ機能

- [ ] 基本ログレベル実装
- [ ] エラーログ自動出力
- [ ] ローテーション設定

### Phase 2: 監査・分析強化

- [ ] 監査ログ実装
- [ ] 音声処理ログ
- [ ] 基本的な分析機能

### Phase 3: 運用最適化

- [ ] 自動アラート設定
- [ ] ダッシュボード構築
- [ ] 高度な分析機能

---

## 📝 まとめ

BUD のログ設計は**実用性とプライバシー保護**を両立し、**運用しやすい**仕組みを目指します。

**重要原則**:

1. **プライバシー第一**: 音声データ・個人情報の適切な保護
2. **実用的な監視**: 本当に必要な情報のみ記録
3. **運用効率**: チームで実際に活用できるログ設計
4. **段階的改善**: 運用しながらログ品質を向上

小規模チームでも維持可能な、実用的なログ設計を実現します。
